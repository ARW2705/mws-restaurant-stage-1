"use strict";importScripts("/js/idb.js");var cacheBaseName="restaurant-reviews",cacheStatic=cacheBaseName+"-static",cacheImages=cacheBaseName+"-images",version="v1.0.0",initComplete=!1,dbPromise=idb.open("restaurantDB",2,function(e){switch(e.oldVersion){case 0:e.createObjectStore("restaurants",{keyPath:"id"});case 1:e.createObjectStore("reviews",{keyPath:"id"})}});self.addEventListener("install",function(e){e.waitUntil(caches.open(cacheStatic+"-"+version).then(function(e){return e.addAll(["/","index.html","restaurant.html","css/styles.css","js/idb.js","js/dbhelper.js","js/main.js","js/restaurant_info.js","img/icons/restaurant-icon-sm.png","img/map/staticmap.webp","img/map/staticmap.png"])}))});var handleDBRequest=function(e,t){var r=e.request.url;console.log(e.request);var n=new URL(e.request.url),s=n.pathname.substring(1,n.pathname.length);"restaurants"==s&&-1!=t&&(r=e.request.url+"/"+t);var a=new Headers,c=!0,i=!1,o=void 0;try{for(var u,l=e.request.headers.entries()[Symbol.iterator]();!(c=(u=l.next()).done);c=!0){var h=u.value;a.append(h[0],h[1])}}catch(e){i=!0,o=e}finally{try{!c&&l.return&&l.return()}finally{if(i)throw o}}a.append("content-type","application/json"),console.log("For path "+s+", using url "+r);var f=new Request(r,{method:e.request.method,headers:a,body:e.request.body,referrer:e.request.referrer,referrerPolicy:e.request.referrerPolicy,mode:e.request.mode,credentials:e.request.credentials,cache:e.request.cache,redirect:e.request.redirect,integrity:e.request.integrity});e.respondWith(dbPromise.then(function(r){return console.log(s),r.transaction(s).objectStore(s).getAll().then(function(e){return console.log("should be",s,t),console.log(e),"restaurants"==s&&-1!=t&&e&&e.length?e.find(function(e){return e.id==t}):initComplete&&e&&e.length?e:fetch(f).then(function(e){return e.json()}).then(function(e){var t=r.transaction(s,"readwrite").objectStore(s);return Array.isArray(e)?(initComplete=!0,e.forEach(function(e){t.put(e)})):t.put(e),e}).catch(function(e){return console.log("DB fetch event failed",e)})}).then(function(e){return new Response(JSON.stringify(e))}).catch(function(e){return console.log("DB fetch failed",e)})}))},handleAssetRequest=function(s){s.respondWith(caches.match(s.request,{ignoreSearch:!0}).then(function(e){if(e)return e;var n=s.request.clone();return fetch(n).then(function(e){if(!e||200!==e.status||"basic"!==e.type)return e;var t=e.clone(),r=("image"===n.destination?cacheImages:cacheStatic)+"-"+version;return caches.open(r).then(function(e){e.put(s.request,t)}).catch(function(e){return console.log("Cache error",e)}),e})}).catch(function(e){return console.log("Cache fetch error",e)}))};self.addEventListener("fetch",function(e){var t=-1,r=new URL(e.request.url).port;if("1337"==r){var n=e.request.referrer;if(-1!=n.indexOf("restaurant.html")){var s=n.indexOf("=")+1;t=parseInt(n.slice(s))}handleDBRequest(e,t)}else"8000"==r&&handleAssetRequest(e)}),self.addEventListener("activate",function(e){e.waitUntil(caches.keys().then(function(e){return Promise.all(e.filter(function(e){return e.startsWith(cacheBaseName)&&!e.endsWith(version)}).map(function(e){return caches.delete(e)}))}).catch(function(e){return console.log("uh-oh",e)}))}),self.addEventListener("error",function(e){console.log("SW error",e)});